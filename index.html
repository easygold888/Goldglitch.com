<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0c10" />
  <title>EasyGoldGlitch — Stop trading. Start printing.</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    :root{
      --bg0:#06070a;
      --bg1:#0b0c10;
      --glass: rgba(255,255,255,.06);
      --glass2: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.10);
      --stroke2: rgba(212,175,55,.20);
      --text:#e9eaee;
      --muted: rgba(233,234,238,.70);
      --muted2: rgba(233,234,238,.55);
      --gold:#d4af37;
      --gold2:#ffd476;
      --shadow: 0 22px 80px rgba(0,0,0,.62);
      --r22: 22px;
      --r28: 28px;
    }

    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0;
      font-family: "Space Grotesk", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background: radial-gradient(1200px 600px at 30% 20%, rgba(212,175,55,.11), transparent 55%),
                  radial-gradient(900px 500px at 80% 0%, rgba(140,120,255,.10), transparent 55%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    /* BACKGROUND CANVAS */
    #fx {
      position:fixed; inset:0;
      width:100%; height:100%;
      z-index:0;
      pointer-events:none;
      opacity: 1;
    }
    .vignette{
      position:fixed; inset:-2px;
      z-index:1;
      pointer-events:none;
      background:
        radial-gradient(1200px 700px at 35% 15%, rgba(0,0,0,0), rgba(0,0,0,.55) 70%),
        radial-gradient(900px 700px at 75% 10%, rgba(0,0,0,0), rgba(0,0,0,.60) 72%),
        radial-gradient(900px 800px at 50% 105%, rgba(0,0,0,0), rgba(0,0,0,.70) 70%);
      mix-blend-mode: multiply;
    }

    /* LAYOUT */
    .wrap{
      position:relative;
      z-index:2;
      max-width: 1180px;
      margin: 0 auto;
      padding: 24px 18px 64px;
    }

    /* GLASS */
    .glass{
      background: linear-gradient(135deg, rgba(255,255,255,.085), rgba(255,255,255,.035));
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    .soft{
      box-shadow: 0 18px 65px rgba(0,0,0,.52);
    }
    .pill{
      border-radius: 999px;
    }
    .card{
      border-radius: var(--r22);
    }
    .panel{
      border-radius: var(--r28);
    }

    /* TOP NAV */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      padding: 14px 16px;
      border-radius: 999px;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      min-width: 210px;
    }
    .logo{
      width: 36px; height:36px;
      border-radius: 12px;
      border:1px solid rgba(212,175,55,.28);
      box-shadow: 0 12px 35px rgba(0,0,0,.45);
      overflow:hidden;
      background: rgba(0,0,0,.2);
      flex: 0 0 auto;
    }
    .logo img{ width:100%; height:100%; object-fit: cover; display:block }
    .brand h1{
      font-size: 16px;
      margin:0;
      letter-spacing:.2px;
    }
    .brand .sub{
      margin-top:2px;
      font-size: 12px;
      color: var(--muted2);
    }
    .nav{
      display:flex;
      gap:8px;
      padding: 6px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.12);
    }
    .nav button{
      appearance:none;
      border:0;
      cursor:pointer;
      color: var(--muted);
      background: transparent;
      padding: 10px 14px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 13px;
      transition: transform .15s ease, background .15s ease, color .15s ease;
      user-select:none;
      white-space:nowrap;
    }
    .nav button:hover{ transform: translateY(-1px); color: var(--text); background: rgba(255,255,255,.06); }
    .nav button.active{
      color: var(--text);
      background: radial-gradient(160px 50px at 50% 50%, rgba(212,175,55,.20), rgba(255,255,255,.06));
      border: 1px solid rgba(212,175,55,.22);
    }

    .quote{
      display:flex;
      flex-direction:column;
      gap:4px;
      align-items:flex-end;
      min-width: 210px;
    }
    .quote .row{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.10);
    }
    .quote .k{
      color: var(--muted2);
      font-size: 12px;
      letter-spacing:.2px;
    }
    .quote .v{
      font-weight: 700;
      font-size: 13px;
    }
    .quote .meta{
      color: var(--muted2);
      font-size: 12px;
    }
    .dot{
      width:7px; height:7px; border-radius:999px;
      background: rgba(212,175,55,.75);
      box-shadow: 0 0 14px rgba(212,175,55,.35);
    }

    /* PANELS */
    .hero{
      margin-top: 18px;
      padding: 28px;
    }
    .badge{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      color: var(--muted);
      font-size: 12px;
      font-weight: 600;
    }
    .hero h2{
      margin: 16px 0 10px;
      font-size: clamp(44px, 5.2vw, 78px);
      line-height: .92;
      letter-spacing: -1.2px;
    }
    .hero p{
      margin: 0;
      color: var(--muted);
      font-size: 15px;
    }
    .cta{
      margin-top: 18px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .btn{
      appearance:none; border:0; cursor:pointer;
      padding: 12px 16px;
      border-radius: 999px;
      font-weight: 800;
      font-size: 13px;
      color: var(--text);
      background: rgba(255,255,255,.07);
      border: 1px solid rgba(255,255,255,.10);
      transition: transform .15s ease, filter .15s ease, background .15s ease;
      user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); filter: brightness(1.05); }
    .btn.gold{
      color: #151515;
      background: radial-gradient(180px 60px at 20% 20%, rgba(255,244,210,.95), rgba(212,175,55,.95));
      border: 1px solid rgba(255,212,118,.55);
      box-shadow: 0 18px 55px rgba(212,175,55,.18);
    }

    .section{
      margin-top: 18px;
      padding: 20px;
    }
    .sectionHeader{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:12px;
      margin-bottom: 14px;
    }
    .sectionHeader h3{
      margin:0;
      font-size: 16px;
      letter-spacing: .2px;
    }
    .sectionHeader .hint{
      color: var(--muted2);
      font-size: 12px;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 12px;
    }
    .tile{
      grid-column: span 4;
      padding: 16px;
      display:flex;
      flex-direction:column;
      gap: 10px;
      min-height: 180px;
    }
    .priceRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .tile h4{
      margin:0;
      font-size: 16px;
      line-height: 1.15;
      letter-spacing: -.2px;
    }
    .usd{
      font-weight: 900;
      font-size: 18px;
      color: var(--gold2);
    }
    .usd span{
      display:block;
      margin-top: 2px;
      font-size: 11px;
      color: var(--muted2);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .8px;
    }
    .chips{ display:flex; gap:8px; flex-wrap:wrap }
    .chip{
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted);
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.15);
    }
    .mini{
      margin:0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }
    .tile .actions{
      margin-top:auto;
      display:flex;
      gap:10px;
    }
    .tile .actions .btn{ width: 100%; justify-content:center; display:flex; }

    /* VIEWS */
    .view{ display:none; }
    .view.active{ display:block; }

    /* MODAL */
    .modalBack{
      position:fixed; inset:0;
      display:none;
      z-index: 50;
      background: rgba(0,0,0,.62);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      padding: 18px;
    }
    .modalBack.show{ display:flex; align-items:center; justify-content:center; }
    .modal{
      width: min(980px, 100%);
      max-height: min(86vh, 860px);
      overflow:auto;
      border-radius: 26px;
      padding: 16px;
    }
    .modalTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 8px 6px 12px;
    }
    .modalTop h3{ margin:0; font-size: 16px; }
    .xbtn{
      width: 40px; height:40px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor:pointer;
      display:grid; place-items:center;
    }
    .modalGrid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap: 12px;
    }
    .box{ padding: 16px; border-radius: 22px; }
    .box h4{ margin:0 0 8px; font-size: 14px; color: var(--muted); letter-spacing:.2px }
    .big{
      font-size: 22px;
      font-weight: 900;
      margin: 0 0 4px;
    }
    .desc{ margin:0; color: var(--muted); font-size: 13px; line-height:1.45 }
    .hr{
      height:1px;
      background: rgba(255,255,255,.08);
      margin: 12px 0;
    }

    .payRow{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
    }
    .payRow .l{ color: var(--muted2); font-size: 12px; }
    .payRow .r{ font-weight: 900; }
    .qr{
      width: 100%;
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
      background: rgba(0,0,0,.14);
      display:grid; place-items:center;
      padding: 12px;
    }
    .qr img{
      width: min(280px, 70vw);
      height:auto;
      display:block;
      border-radius: 16px;
      border: 1px solid rgba(212,175,55,.20);
      box-shadow: 0 18px 55px rgba(0,0,0,.45);
    }
    .addr{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .addr code{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      color: rgba(233,234,238,.85);
      word-break: break-all;
    }
    .smallBtn{
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-weight: 800;
      cursor:pointer;
      white-space:nowrap;
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top: 12px;
    }
    .field label{
      font-size: 12px;
      color: var(--muted2);
      font-weight: 700;
    }
    input[type="email"]{
      width:100%;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline:none;
      font-weight: 700;
    }
    input[type="email"]::placeholder{ color: rgba(233,234,238,.40) }

    .check{
      display:flex;
      gap:10px;
      align-items:flex-start;
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.12);
    }
    .check input{ margin-top: 2px; }
    .check .t{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }
    .payBtn{
      margin-top: 12px;
      width:100%;
      display:flex;
      justify-content:center;
      align-items:center;
      gap:10px;
    }

    /* TERMS */
    .terms p, .terms li{
      color: var(--muted);
      font-size: 13px;
      line-height: 1.55;
    }
    .terms ul{ margin: 8px 0 0 18px; padding:0 }

    /* RESPONSIVE */
    @media (max-width: 940px){
      .quote{ display:none; }
      .brand{ min-width:auto; }
      .tile{ grid-column: span 12; }
      .modalGrid{ grid-template-columns: 1fr; }
      .hero{ padding: 20px; }
      .hero h2{ font-size: 48px; }
      .nav button{ padding: 10px 12px; }
    }

    @media (prefers-reduced-motion: reduce){
      #fx{ display:none; }
    }
  </style>
</head>

<body>
  <canvas id="fx"></canvas>
  <div class="vignette"></div>

  <div class="wrap">
    <!-- TOP -->
    <div class="topbar glass pill soft">
      <div class="brand">
        <div class="logo">
          <img src="./logo.png" alt="EasyGoldGlitch logo" onerror="this.style.display='none'">
        </div>
        <div>
          <h1>EasyGoldGlitch</h1>
          <div class="sub">Stop trading. Start printing.</div>
        </div>
      </div>

      <div class="nav">
        <button class="active" data-nav="home">Home</button>
        <button data-nav="exploits">Exploits</button>
        <button data-nav="terms">Terms</button>
      </div>

      <div class="quote" aria-live="polite">
        <div class="row">
          <span class="dot"></span>
          <div class="k">ETH:</div>
          <div class="v" id="ethUsd">—</div>
          <div class="k" style="margin-left:8px">Weekly high:</div>
          <div class="v" id="ethWh">—</div>
        </div>
        <div class="meta">Quote refresh: <span id="quoteCd">—</span></div>
      </div>
    </div>

    <!-- HOME -->
    <section id="view-home" class="view active">
      <div class="hero glass panel soft">
        <span class="badge"><i data-lucide="sparkles" style="width:14px;height:14px"></i> Crypto-native • No sign-up</span>
        <h2>Stop trading.<br>Start printing.</h2>
        <p>Pick a glitch. Pay in ETH. Get delivery.</p>

        <div class="cta">
          <button class="btn gold" id="goExploits">Browse exploits</button>
          <button class="btn" id="goTerms">Terms</button>
        </div>
      </div>

      <div class="section glass panel soft">
        <div class="sectionHeader">
          <div>
            <h3>Fast picks</h3>
            <div class="hint">Low text. High signal. ETH uses weekly high.</div>
          </div>
          <div class="hint">Tap/click the background for more gold.</div>
        </div>

        <div class="grid" id="homeGrid"></div>
      </div>
    </section>

    <!-- EXPLOITS -->
    <section id="view-exploits" class="view">
      <div class="section glass panel soft">
        <div class="sectionHeader">
          <div>
            <h3>Exploits</h3>
            <div class="hint">Select • View • Checkout</div>
          </div>
          <div class="hint">Quote locks locally for 10 minutes.</div>
        </div>

        <div class="grid" id="exploitGrid"></div>
      </div>
    </section>

    <!-- TERMS -->
    <section id="view-terms" class="view">
      <div class="section glass panel soft terms">
        <div class="sectionHeader">
          <div>
            <h3>Terms & Risk</h3>
            <div class="hint">Read before paying.</div>
          </div>
        </div>

        <p><b>High risk.</b> Trading can result in partial or total loss of capital. Past performance does not guarantee future results.</p>
        <p><b>No refunds.</b> Digital delivery, one-time payment.</p>
        <p><b>Demo duration.</b> Demo products run for <b>2 months</b> per license. The “Little Glitcher” add-on can extend demo lifetime and replicate to multiple terminals.</p>

        <div class="hr"></div>
        <p><b>Operational note.</b> If an executable/terminal must remain open to manage positions, you are responsible for keeping it running and connected.</p>
        <ul>
          <li>You accept all market risk and execution risk.</li>
          <li>You are responsible for broker conditions (spreads, slippage, outages).</li>
          <li>We do not provide investment advice.</li>
        </ul>
      </div>
    </section>
  </div>

  <!-- MODAL -->
  <div class="modalBack" id="modalBack" role="dialog" aria-modal="true" aria-label="Exploit details">
    <div class="modal glass soft" id="modal">
      <div class="modalTop">
        <h3 id="mTitle">Exploit</h3>
        <button class="xbtn" id="mClose" aria-label="Close">
          <i data-lucide="x" style="width:18px;height:18px"></i>
        </button>
      </div>

      <div class="modalGrid">
        <div class="box glass card">
          <h4>Summary</h4>
          <div class="big" id="mName">—</div>
          <p class="desc" id="mDesc">—</p>
          <div class="hr"></div>
          <div class="chips" id="mChips"></div>
        </div>

        <div class="box glass card">
          <h4>Checkout</h4>

          <div class="payRow">
            <div class="l">USD price</div>
            <div class="r" id="mUsd">—</div>
          </div>

          <div class="payRow" style="margin-top:10px">
            <div class="l">Pay in ETH (weekly high)</div>
            <div class="r" id="mEth">—</div>
          </div>

          <div class="qr" style="margin-top:12px">
            <img src="./wallet.png" alt="Wallet QR" onerror="this.style.display='none'">
          </div>

          <div class="addr">
            <code id="walletAddr">Loading address…</code>
            <button class="smallBtn" id="copyAddr">Copy</button>
          </div>

          <div class="field">
            <label for="email">Email (delivery)</label>
            <input id="email" type="email" placeholder="you@domain.com" autocomplete="email" />
          </div>

          <div class="check">
            <input id="accept" type="checkbox" />
            <div class="t">
              I agree to the <b>Terms</b> and understand the <b>risk</b>. Demo products run for <b>2 months</b>.
            </div>
          </div>

          <button class="btn gold payBtn" id="checkoutBtn">
            <i data-lucide="credit-card" style="width:16px;height:16px"></i>
            Show payment details
          </button>

          <div class="hint" style="margin-top:10px">
            We’ll add TxHash verification next phase. For now: pay → keep TxHash → support delivery flow.
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* -----------------------------
   DATA
------------------------------ */
const EXPLOITS = [
  {
    id: "g1",
    title: "Glitch 1.0 — Simple Sample",
    usd: 50,
    label: "Demo • 2 months",
    chips: ["1 trade at a time", "low-noise", "demo license"],
    desc: "Minimal exposure. One position at a time. Clean execution for trending / directional markets."
  },
  {
    id: "g2",
    title: "Glitch 2.0 — Wealth Builder",
    usd: 70,
    label: "Demo • 2 months",
    chips: ["dip refill", "low stress", "demo license"],
    desc: "Buy & hold logic with a controlled re-buy if price dips. Built for long-biased regimes."
  },
  {
    id: "g3",
    title: "Glitch Pro — F*ck Gold",
    usd: 100,
    label: "Pro • Lifetime",
    chips: ["lifetime", "higher impact", "pro license"],
    desc: "Full-strength execution. Designed for aggressive opportunity capture when volatility expands."
  },
  {
    id: "g4",
    title: "Little Glitcher — Demo Unlocker",
    usd: 150,
    label: "Addon • Lifetime",
    chips: ["unlocks demo time", "up to 10 accounts", "copy engine"],
    desc: "Extends demo glitches you own to run forever and replicate across up to 10 terminals. No lot/logic edits — it’s a copy-style printer."
  }
];

/* -----------------------------
   NAV + VIEWS
------------------------------ */
const views = {
  home: document.getElementById("view-home"),
  exploits: document.getElementById("view-exploits"),
  terms: document.getElementById("view-terms")
};

function setView(name){
  Object.entries(views).forEach(([k, el]) => el.classList.toggle("active", k===name));
  document.querySelectorAll(".nav button").forEach(b => b.classList.toggle("active", b.dataset.nav === name));
  window.scrollTo({ top: 0, behavior: "smooth" });
}

document.querySelectorAll(".nav button").forEach(btn => {
  btn.addEventListener("click", () => setView(btn.dataset.nav));
});
document.getElementById("goExploits").addEventListener("click", ()=> setView("exploits"));
document.getElementById("goTerms").addEventListener("click", ()=> setView("terms"));

/* -----------------------------
   RENDER CARDS
------------------------------ */
function exploitCardHTML(x){
  return `
    <div class="tile glass card">
      <div class="priceRow">
        <h4>${x.title}</h4>
        <div class="usd">$${x.usd}<span>${x.label}</span></div>
      </div>
      <div class="chips">
        ${x.chips.map(c => `<span class="chip">${c}</span>`).join("")}
      </div>
      <p class="mini">${x.desc}</p>
      <div class="actions">
        <button class="btn gold" data-open="${x.id}">View</button>
        <button class="btn" data-checkout="${x.id}">Checkout</button>
      </div>
    </div>
  `;
}
function renderExploitGrids(){
  const homeGrid = document.getElementById("homeGrid");
  const exploitGrid = document.getElementById("exploitGrid");

  homeGrid.innerHTML = EXPLOITS.map(exploitCardHTML).join("");
  exploitGrid.innerHTML = EXPLOITS.map(exploitCardHTML).join("");

  document.querySelectorAll("[data-open]").forEach(b => b.addEventListener("click", () => openModal(b.dataset.open)));
  document.querySelectorAll("[data-checkout]").forEach(b => b.addEventListener("click", () => openModal(b.dataset.checkout, true)));
}
renderExploitGrids();

/* -----------------------------
   MODAL
------------------------------ */
const modalBack = document.getElementById("modalBack");
const mClose = document.getElementById("mClose");
const mTitle = document.getElementById("mTitle");
const mName  = document.getElementById("mName");
const mDesc  = document.getElementById("mDesc");
const mChips = document.getElementById("mChips");
const mUsd   = document.getElementById("mUsd");
const mEth   = document.getElementById("mEth");
const email  = document.getElementById("email");
const accept = document.getElementById("accept");

let selected = null;

function closeModal(){
  modalBack.classList.remove("show");
  selected = null;
}
mClose.addEventListener("click", closeModal);
modalBack.addEventListener("click", (e) => { if(e.target === modalBack) closeModal(); });
document.addEventListener("keydown", (e)=>{ if(e.key==="Escape" && modalBack.classList.contains("show")) closeModal(); });

function openModal(id, goCheckout=false){
  selected = EXPLOITS.find(x => x.id === id);
  if(!selected) return;

  mTitle.textContent = "Exploit details";
  mName.textContent  = selected.title;
  mDesc.textContent  = selected.desc;

  mChips.innerHTML = selected.chips.map(c => `<span class="chip">${c}</span>`).join("");
  mUsd.textContent = `$${selected.usd}`;

  updatePayInEth(); // uses latest quote
  email.value = "";
  accept.checked = false;

  modalBack.classList.add("show");
  lucide.createIcons();

  if(goCheckout){
    // nothing special; modal already shows checkout
  }
}

/* -----------------------------
   WALLET ADDRESS LOADER
------------------------------ */
const walletAddrEl = document.getElementById("walletAddr");
async function loadAddress(){
  try{
    // force fresh but allow browser caching semantics
    const r = await fetch("./address.txt", { cache: "no-store" });
    const t = (await r.text()).trim();
    if(!t) throw new Error("empty address");
    walletAddrEl.textContent = t;
  }catch(err){
    walletAddrEl.textContent = "Address not available. Check address.txt";
  }
}
loadAddress();

document.getElementById("copyAddr").addEventListener("click", async ()=>{
  try{
    await navigator.clipboard.writeText(walletAddrEl.textContent.trim());
    toast("Copied");
  }catch(e){
    toast("Copy failed");
  }
});

/* -----------------------------
   ETH QUOTE (FIXED: NEVER BLANKS OUT)
   - Refresh target: every 10 minutes
   - If refresh fails: keep last good quote (UI stays)
   - Prevent hammering: retry no more than every 30s when stale
------------------------------ */
const quoteEls = {
  usd: document.getElementById("ethUsd"),
  wh:  document.getElementById("ethWh"),
  cd:  document.getElementById("quoteCd")
};

const QUOTE_TTL_MS = 10 * 60 * 1000;
const RETRY_BACKOFF_MS = 30 * 1000;
const LS_KEY = "egg_eth_quote_v2";

let quote = null;
let lastAttemptAt = 0;

function fmtUsd(n){
  if(typeof n !== "number" || !isFinite(n)) return "—";
  return "$" + n.toLocaleString(undefined, { maximumFractionDigits: 0 });
}
function fmtEth(n){
  if(typeof n !== "number" || !isFinite(n)) return "—";
  // show up to 6 decimals for small amounts
  return n.toLocaleString(undefined, { maximumFractionDigits: 6 });
}
function readCachedQuote(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return null;
    const q = JSON.parse(raw);
    if(!q || typeof q !== "object") return null;
    return q;
  }catch(e){ return null; }
}
function writeCachedQuote(q){
  try{ localStorage.setItem(LS_KEY, JSON.stringify(q)); }catch(e){}
}

function renderQuote(q, {stale=false} = {}){
  if(!q) return;
  quoteEls.usd.textContent = fmtUsd(q.ethUsd);
  quoteEls.wh.textContent  = fmtUsd(q.weekHighUsd);
  // countdown text is handled by tickCountdown; if stale, it will show "stale"
}

async function refreshQuote({force=false} = {}){
  const now = Date.now();
  if(!force && quote && (now - quote.refreshedAt) < QUOTE_TTL_MS) return;

  // prevent hammering when we are stale and Binance/edge fails
  if(now - lastAttemptAt < RETRY_BACKOFF_MS) return;
  lastAttemptAt = now;

  const controller = new AbortController();
  const t = setTimeout(()=>controller.abort(), 8000);

  try{
    const res = await fetch("/api/eth-quote", {
      method: "GET",
      cache: "no-store",
      signal: controller.signal
    });
    clearTimeout(t);
    if(!res.ok) throw new Error("quote http " + res.status);
    const data = await res.json();

    // expected: { ethUsd, weekHighUsd, refreshedAt }
    const q = {
      ethUsd: Number(data.ethUsd),
      weekHighUsd: Number(data.weekHighUsd),
      refreshedAt: Date.now()
    };
    if(!isFinite(q.ethUsd) || !isFinite(q.weekHighUsd)) throw new Error("bad quote");

    quote = q;
    quote.__stale = false;

    writeCachedQuote(quote);
    renderQuote(quote);
    updatePayInEth();
  }catch(err){
    clearTimeout(t);

    // IMPORTANT FIX:
    // - Do NOT blank the UI
    // - Keep last good quote (memory) OR fallback to cached quote
    if(!quote){
      const cached = readCachedQuote();
      if(cached){
        quote = cached;
      }
    }
    if(quote){
      quote.__stale = true;
      renderQuote(quote, {stale:true});
      updatePayInEth();
    }else{
      // only if we truly have nothing
      quoteEls.usd.textContent = "—";
      quoteEls.wh.textContent  = "—";
    }
  }
}

function tickCountdown(){
  if(!quote){
    quoteEls.cd.textContent = "—";
    return;
  }
  const now = Date.now();
  const age = now - quote.refreshedAt;
  const left = Math.max(0, QUOTE_TTL_MS - age);

  if(left === 0){
    // stale: attempt refresh, but don’t spam
    refreshQuote({force:true});
    quoteEls.cd.textContent = quote.__stale ? "stale" : "00:00";
    return;
  }

  const m = Math.floor(left / 60000);
  const s = Math.floor((left % 60000) / 1000);
  quoteEls.cd.textContent = `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
}

function getPayBasisUsd(){
  // price basis: weekly high preferred (your rule)
  if(quote && isFinite(quote.weekHighUsd) && quote.weekHighUsd > 0) return quote.weekHighUsd;
  if(quote && isFinite(quote.ethUsd) && quote.ethUsd > 0) return quote.ethUsd;
  return null;
}

function updatePayInEth(){
  if(!selected) return;
  const basis = getPayBasisUsd();
  if(!basis){
    mEth.textContent = "—";
    return;
  }
  const eth = selected.usd / basis;
  mEth.textContent = `${fmtEth(eth)} ETH`;
}

(async function initQuote(){
  // load cached immediately (instant UI)
  const cached = readCachedQuote();
  if(cached){
    quote = cached;
    renderQuote(quote);
  }
  // fetch fresh
  await refreshQuote({force:true});
  tickCountdown();
  setInterval(tickCountdown, 1000);
  // also a soft refresh loop (in case tab sleeps)
  setInterval(()=>refreshQuote({force:false}), 30 * 1000);
})();

/* -----------------------------
   CHECKOUT BUTTON (MVP)
------------------------------ */
document.getElementById("checkoutBtn").addEventListener("click", ()=>{
  if(!selected) return;

  const em = email.value.trim();
  if(!em || !em.includes("@")){
    toast("Enter a valid email");
    return;
  }
  if(!accept.checked){
    toast("Accept terms to continue");
    return;
  }

  const basis = getPayBasisUsd();
  const eth = basis ? (selected.usd / basis) : null;

  const msg = [
    "PAYMENT DETAILS",
    `Item: ${selected.title}`,
    `USD: $${selected.usd}`,
    eth ? `ETH (weekly high): ${eth.toFixed(6)} ETH` : "ETH: —",
    `Address: ${walletAddrEl.textContent.trim()}`,
    `Email: ${em}`,
    "",
    "After paying: save your TxHash."
  ].join("\n");

  navigator.clipboard.writeText(msg).then(()=>toast("Payment details copied"));
});

/* -----------------------------
   TOAST
------------------------------ */
let toastTimer = null;
function toast(text){
  let el = document.getElementById("toast");
  if(!el){
    el = document.createElement("div");
    el.id = "toast";
    el.style.position = "fixed";
    el.style.left = "50%";
    el.style.bottom = "22px";
    el.style.transform = "translateX(-50%)";
    el.style.padding = "10px 14px";
    el.style.borderRadius = "999px";
    el.style.border = "1px solid rgba(255,255,255,.12)";
    el.style.background = "rgba(0,0,0,.45)";
    el.style.backdropFilter = "blur(10px)";
    el.style.webkitBackdropFilter = "blur(10px)";
    el.style.color = "rgba(233,234,238,.95)";
    el.style.fontWeight = "800";
    el.style.fontSize = "13px";
    el.style.zIndex = "200";
    el.style.boxShadow = "0 18px 55px rgba(0,0,0,.45)";
    document.body.appendChild(el);
  }
  el.textContent = text;
  el.style.opacity = "1";
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>{ el.style.opacity = "0"; }, 1200);
}

/* -----------------------------
   ICONS
------------------------------ */
lucide.createIcons();

/* -----------------------------
   PARTICLES FX (gold grains, free-floating, connected, click spawns more)
------------------------------ */
const canvas = document.getElementById("fx");
const ctx = canvas.getContext("2d", { alpha: true });

let W=0, H=0, DPR=1;
function resize(){
  DPR = Math.min(2, window.devicePixelRatio || 1);
  W = Math.floor(window.innerWidth);
  H = Math.floor(window.innerHeight);
  canvas.width  = Math.floor(W * DPR);
  canvas.height = Math.floor(H * DPR);
  canvas.style.width = W+"px";
  canvas.style.height = H+"px";
  ctx.setTransform(DPR,0,0,DPR,0,0);
}
window.addEventListener("resize", resize, { passive:true });
resize();

const pointer = { x: W*0.5, y: H*0.5, active:false };
window.addEventListener("pointermove", (e)=>{
  pointer.x = e.clientX; pointer.y = e.clientY; pointer.active=true;
}, { passive:true });

window.addEventListener("pointerdown", (e)=>{
  spawnBurst(e.clientX, e.clientY, 18);
}, { passive:true });

const particles = [];
function rnd(a,b){ return a + Math.random()*(b-a); }

function addParticle(x,y,boost=false){
  const r = rnd(1.2, 3.2) * (boost ? 1.1 : 1.0);
  particles.push({
    x, y,
    vx: rnd(-0.18, 0.18),
    vy: rnd(-0.18, 0.18),
    r,
    a: rnd(0.55, 1.0),
    tw: rnd(0, Math.PI*2),
    m: rnd(0.7, 1.5)
  });
}

function seed(){
  particles.length = 0;
  const base = Math.round((W*H)/18000);   // density
  const n = Math.max(70, Math.min(170, base));
  for(let i=0;i<n;i++){
    addParticle(rnd(0,W), rnd(0,H));
  }
}
seed();

function spawnBurst(x,y,n){
  for(let i=0;i<n;i++){
    addParticle(x + rnd(-10,10), y + rnd(-10,10), true);
    // give a little "kick" outward
    const p = particles[particles.length-1];
    const ang = rnd(0, Math.PI*2);
    const sp = rnd(0.6, 1.6);
    p.vx += Math.cos(ang)*sp;
    p.vy += Math.sin(ang)*sp;
  }
  // cap
  while(particles.length > 220) particles.shift();
}

function draw(){
  ctx.clearRect(0,0,W,H);

  // subtle haze
  const haze = ctx.createRadialGradient(W*0.28, H*0.20, 0, W*0.28, H*0.20, Math.max(W,H)*0.9);
  haze.addColorStop(0, "rgba(212,175,55,0.06)");
  haze.addColorStop(1, "rgba(0,0,0,0)");
  ctx.fillStyle = haze;
  ctx.fillRect(0,0,W,H);

  // physics
  for(const p of particles){
    // gentle wander
    p.tw += 0.02 * p.m;
    p.vx += Math.cos(p.tw) * 0.003;
    p.vy += Math.sin(p.tw) * 0.003;

    // pointer repel
    if(pointer.active){
      const dx = p.x - pointer.x;
      const dy = p.y - pointer.y;
      const d2 = dx*dx + dy*dy;
      const rad = 140;
      if(d2 < rad*rad){
        const d = Math.sqrt(d2) || 1;
        const f = (1 - d/rad) * 0.09;
        p.vx += (dx/d) * f;
        p.vy += (dy/d) * f;
      }
    }

    // mild cohesion (forms "clusters")
    // pick a few neighbors by sampling
    for(let k=0;k<2;k++){
      const q = particles[(Math.random()*particles.length)|0];
      if(q === p) continue;
      const dx = q.x - p.x;
      const dy = q.y - p.y;
      const d2 = dx*dx + dy*dy;
      if(d2 > 0 && d2 < 160*160){
        const d = Math.sqrt(d2);
        const pull = (1 - d/160) * 0.002;
        p.vx += (dx/d) * pull;
        p.vy += (dy/d) * pull;
      }
    }

    // integrate
    p.x += p.vx;
    p.y += p.vy;

    // damping
    p.vx *= 0.985;
    p.vy *= 0.985;

    // wrap
    if(p.x < -20) p.x = W+20;
    if(p.x > W+20) p.x = -20;
    if(p.y < -20) p.y = H+20;
    if(p.y > H+20) p.y = -20;
  }

  // connections
  ctx.lineWidth = 1;
  for(let i=0;i<particles.length;i++){
    const p = particles[i];
    for(let j=i+1;j<particles.length;j++){
      const q = particles[j];
      const dx = q.x - p.x;
      const dy = q.y - p.y;
      const d2 = dx*dx + dy*dy;
      const max = 120;
      if(d2 < max*max){
        const d = Math.sqrt(d2);
        const a = (1 - d/max) * 0.10 * Math.min(p.a, q.a);
        ctx.strokeStyle = `rgba(212,175,55,${a})`;
        ctx.beginPath();
        ctx.moveTo(p.x, p.y);
        ctx.lineTo(q.x, q.y);
        ctx.stroke();
      }
    }
  }

  // particles (gold grains / rocks)
  for(const p of particles){
    const glow = ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,p.r*6.0);
    glow.addColorStop(0, `rgba(255, 240, 200, ${0.35*p.a})`);
    glow.addColorStop(0.35, `rgba(255, 212, 118, ${0.22*p.a})`);
    glow.addColorStop(1, `rgba(212, 175, 55, 0)`);
    ctx.fillStyle = glow;
    ctx.beginPath();
    ctx.arc(p.x,p.y,p.r*6.0,0,Math.PI*2);
    ctx.fill();

    // core
    ctx.fillStyle = `rgba(255, 234, 190, ${0.72*p.a})`;
    ctx.beginPath();
    ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
    ctx.fill();

    // micro glint stroke
    ctx.strokeStyle = `rgba(255, 244, 210, ${0.14*p.a})`;
    ctx.beginPath();
    ctx.arc(p.x+0.6, p.y-0.6, p.r*1.2, 0, Math.PI*2);
    ctx.stroke();
  }

  requestAnimationFrame(draw);
}
draw();
</script>

</body>
</html>
