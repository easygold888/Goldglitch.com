<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#07060b" />
  <title>EasyGoldGlitch — Stop trading. Start printing.</title>
  <style>
    :root{
      --bg0:#05040a;
      --bg1:#0a0813;
      --bg2:#0f0d1b;

      --glass: rgba(255,255,255,.07);
      --glass2: rgba(255,255,255,.10);
      --stroke: rgba(255,255,255,.12);
      --stroke2: rgba(255,255,255,.18);

      --text: rgba(255,255,255,.90);
      --muted: rgba(255,255,255,.70);
      --faint: rgba(255,255,255,.52);

      --gold: #d7b56a;
      --gold2:#f0da9a;
      --char:#17151f;

      --ok:#62ffbf;
      --bad:#ff6b8a;

      --shadow: 0 18px 70px rgba(0,0,0,.55);
      --blur: 18px;
      --r: 22px;
      --r2: 28px;

      --max: 1180px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(215,181,106,.16), transparent 60%),
        radial-gradient(900px 600px at 80% 15%, rgba(160,140,255,.12), transparent 55%),
        radial-gradient(1200px 900px at 50% 110%, rgba(30,210,180,.06), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg2));
      overflow-x:hidden;
    }

    /* Particle canvas */
    #fx {
      position:fixed;
      inset:0;
      z-index:0;
      pointer-events:none;
      opacity:.95;
    }

    /* Soft vignette */
    .vignette{
      position:fixed; inset:-30px;
      z-index:1;
      pointer-events:none;
      background:
        radial-gradient(1100px 750px at 50% 20%, transparent 45%, rgba(0,0,0,.55) 92%),
        radial-gradient(900px 900px at 50% 120%, rgba(0,0,0,.35), rgba(0,0,0,.75));
      mix-blend-mode:multiply;
    }

    .wrap{ position:relative; z-index:2; }

    /* Top bar */
    .top{
      position:sticky;
      top:0;
      z-index:20;
      padding:18px 14px 10px;
      backdrop-filter: blur(12px);
    }

    .nav{
      max-width:var(--max);
      margin:0 auto;
      border-radius:999px;
      background: linear-gradient(90deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      padding:10px 12px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      padding:6px 10px;
      border-radius:999px;
    }
    .logo{
      width:28px; height:28px;
      border-radius:10px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      display:grid; place-items:center;
      overflow:hidden;
    }
    .logo img{ width:100%; height:100%; object-fit:cover; display:block; }
    .brand .name{
      font-weight:800;
      letter-spacing:.3px;
      font-size:16px;
      line-height:1.1;
    }
    .brand .tag{
      font-size:12px;
      color:var(--muted);
      line-height:1.1;
      margin-top:2px;
    }

    .tabs{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      justify-content:center;
      flex:1;
    }
    .pill{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:8px 12px;
      border-radius:999px;
      font-size:13px;
      cursor:pointer;
      user-select:none;
      transition: transform .15s ease, background .15s ease, border-color .15s ease;
    }
    .pill:hover{ transform: translateY(-1px); background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.18); }
    .pill.active{
      background: linear-gradient(180deg, rgba(215,181,106,.20), rgba(255,255,255,.06));
      border-color: rgba(215,181,106,.45);
      box-shadow: 0 10px 30px rgba(215,181,106,.12);
    }

    .actions{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .iconBtn{
      width:42px; height:42px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      display:grid; place-items:center;
      cursor:pointer;
      transition: transform .15s ease, background .15s ease, border-color .15s ease;
    }
    .iconBtn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.09); border-color: rgba(255,255,255,.20); }
    .cartBadge{
      min-width:42px;
      height:42px;
      padding:0 14px;
      border-radius:999px;
      border:1px solid rgba(215,181,106,.30);
      background: rgba(215,181,106,.12);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      cursor:pointer;
      user-select:none;
    }
    .cartBadge b{ color: var(--gold2); }
    .cartBadge span{ color: var(--text); font-size:13px; }

    /* Content */
    .main{
      max-width:var(--max);
      margin: 22px auto 90px;
      padding: 0 14px;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:14px;
    }
    .card{
      border-radius: var(--r2);
      background: linear-gradient(180deg, rgba(255,255,255,.085), rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:-1px;
      background:
        radial-gradient(900px 220px at 25% 0%, rgba(215,181,106,.12), transparent 60%),
        radial-gradient(700px 220px at 80% 0%, rgba(160,140,255,.10), transparent 55%);
      opacity:.9;
      pointer-events:none;
    }
    .inner{
      position:relative;
      padding:18px;
    }

    .hero{
      grid-column: 1 / -1;
      min-height: 300px;
    }
    .hero h1{
      margin:0;
      font-size:44px;
      letter-spacing:-.7px;
      line-height:1.02;
    }
    .hero p{
      margin:10px 0 0;
      max-width: 680px;
      color: var(--muted);
      font-size:15px;
      line-height:1.55;
    }
    .hero .ctaRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:16px;
      align-items:center;
    }
    .btn{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.07);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 14px;
      cursor:pointer;
      transition: transform .15s ease, background .15s ease, border-color .15s ease;
      font-weight:700;
      font-size:13px;
      user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.10); border-color: rgba(255,255,255,.20); }
    .btn.gold{
      border-color: rgba(215,181,106,.45);
      background: linear-gradient(180deg, rgba(215,181,106,.25), rgba(255,255,255,.06));
      box-shadow: 0 18px 60px rgba(215,181,106,.12);
    }
    .btn.ghost{
      background: transparent;
    }

    .kicker{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding: 6px 10px;
      border-radius:999px;
      border:1px solid rgba(215,181,106,.30);
      background: rgba(215,181,106,.10);
      color: var(--gold2);
      font-size:12px;
      font-weight:700;
      letter-spacing:.2px;
    }

    /* Glitches */
    .sectionTitle{
      grid-column:1/-1;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
      margin-top:4px;
    }
    .sectionTitle h2{
      margin:0;
      font-size:18px;
      letter-spacing:-.2px;
    }
    .sectionTitle .sub{
      color:var(--faint);
      font-size:13px;
    }

    .product{
      grid-column: span 6;
    }
    @media (max-width: 860px){
      .hero h1{ font-size:36px; }
      .product{ grid-column: 1 / -1; }
      .tabs{ justify-content:flex-start; }
    }

    .row{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
    }
    .pname{
      font-weight:900;
      letter-spacing:-.2px;
      font-size:16px;
      margin:0;
    }
    .pblurb{ margin:8px 0 0; color:var(--muted); font-size:13px; line-height:1.45; max-width: 520px; }
    .price{
      text-align:right;
      min-width: 140px;
    }
    .price b{
      font-size:18px;
      color: var(--gold2);
      letter-spacing:-.3px;
    }
    .price div{ color: var(--faint); font-size:12px; margin-top:3px; }
    .tags{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:12px;
    }
    .tag{
      font-size:12px;
      color: rgba(255,255,255,.78);
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      padding:6px 10px;
      border-radius:999px;
    }

    .pactions{
      display:flex;
      gap:10px;
      margin-top:14px;
      flex-wrap:wrap;
      align-items:center;
    }
    .mini{
      font-size:12px;
      padding:9px 12px;
      border-radius: 14px;
    }
    .selected{
      border-color: rgba(98,255,191,.40) !important;
      background: rgba(98,255,191,.08) !important;
    }

    /* Modal */
    .modalOverlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.60);
      backdrop-filter: blur(10px);
      z-index:50;
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    .modalOverlay.show{ display:flex; }
    .modal{
      width:min(980px, 100%);
      border-radius: 26px;
      background: linear-gradient(180deg, rgba(20,18,28,.85), rgba(10,8,18,.85));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 30px 120px rgba(0,0,0,.65);
      overflow:hidden;
      position:relative;
    }
    .modalHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:14px 16px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
    .modalHead .mhTitle{
      font-weight:900;
      letter-spacing:-.2px;
      font-size:14px;
      color: rgba(255,255,255,.9);
    }
    .x{
      width:38px; height:38px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      cursor:pointer;
      display:grid; place-items:center;
    }
    .modalBody{
      padding: 16px;
    }
    .mgrid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
    }
    @media (max-width: 920px){
      .mgrid{ grid-template-columns: 1fr; }
    }
    .panel{
      border-radius: 20px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      overflow:hidden;
    }
    .panel .pi{ padding:14px; }
    .panel h3{ margin:0; font-size:14px; letter-spacing:-.2px; }
    .panel p{ margin:8px 0 0; color:var(--muted); font-size:13px; line-height:1.5; }

    .imgBox{
      margin-top:12px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      overflow:hidden;
      aspect-ratio: 16/9;
      display:grid; place-items:center;
      color: rgba(255,255,255,.55);
      font-size:12px;
    }
    .imgBox img{ width:100%; height:100%; object-fit:cover; display:block; }

    .field{
      margin-top:12px;
    }
    label{
      display:block;
      font-size:12px;
      color: rgba(255,255,255,.70);
      margin-bottom:6px;
    }
    input, textarea, select{
      width:100%;
      padding:11px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      color: rgba(255,255,255,.92);
      outline:none;
    }
    input:focus, textarea:focus{
      border-color: rgba(215,181,106,.45);
      box-shadow: 0 0 0 4px rgba(215,181,106,.12);
    }
    .split{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 520px){
      .split{ grid-template-columns: 1fr; }
    }

    .walletRow{
      display:flex;
      gap:12px;
      align-items:flex-start;
      margin-top:12px;
    }
    .qr{
      width:120px; height:120px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      overflow:hidden;
      flex:0 0 auto;
      display:grid; place-items:center;
    }
    .qr img{ width:100%; height:100%; object-fit:cover; display:block; }
    .addrBox{
      flex:1;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      padding:10px;
      min-height:120px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      gap:8px;
    }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
      color: rgba(255,255,255,.86);
      word-break: break-all;
      line-height:1.35;
    }
    .addrActions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }

    .note{
      margin-top:10px;
      font-size:12px;
      color: rgba(255,255,255,.58);
      line-height:1.45;
    }

    .checkRow{
      display:flex;
      align-items:flex-start;
      gap:10px;
      margin-top:12px;
      padding:10px 12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }
    .checkRow input{ width:auto; margin-top:2px; }
    .checkRow span{ font-size:12px; color: rgba(255,255,255,.72); line-height:1.4; }

    .status{
      margin-top:12px;
      padding:10px 12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      font-size:12px;
      color: rgba(255,255,255,.75);
      line-height:1.45;
    }
    .status.ok{ border-color: rgba(98,255,191,.30); background: rgba(98,255,191,.06); }
    .status.bad{ border-color: rgba(255,107,138,.30); background: rgba(255,107,138,.06); }

    /* Toasts */
    .toasts{
      position:fixed;
      right:16px;
      bottom:16px;
      z-index:60;
      display:flex;
      flex-direction:column;
      gap:10px;
      pointer-events:none;
    }
    .toast{
      width:min(340px, calc(100vw - 32px));
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(20,18,28,.72);
      backdrop-filter: blur(16px);
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
      padding: 10px 12px;
      pointer-events:none;
      transform: translateY(6px);
      opacity:0;
      transition: opacity .25s ease, transform .25s ease;
    }
    .toast.show{ opacity:1; transform: translateY(0); }
    .toast b{ color: var(--gold2); font-size:12px; }
    .toast div{ color: rgba(255,255,255,.72); font-size:12px; margin-top:4px; }

    /* Footer spacing */
    .spacer{ height: 40px; }
  </style>
</head>

<body>
  <canvas id="fx"></canvas>
  <div class="vignette"></div>

  <div class="wrap">
    <header class="top">
      <div class="nav">
        <div class="brand">
          <div class="logo" title="Logo">
            <img src="./Logo.png" alt="EasyGoldGlitch logo" onerror="this.style.display='none'; this.parentNode.textContent='⚡';" />
          </div>
          <div>
            <div class="name">EasyGoldGlitch</div>
            <div class="tag">Stop trading. Start printing.</div>
          </div>
        </div>

        <nav class="tabs" id="tabs">
          <div class="pill active" data-view="home">Home</div>
          <div class="pill" data-view="glitches">Glitches</div>
          <div class="pill" data-view="philosophy">Philosophy</div>
          <div class="pill" data-view="terms">Terms</div>
        </nav>

        <div class="actions">
          <div class="cartBadge" id="cartBtn" title="Checkout">
            <b id="cartCount">0</b>
            <span>Checkout</span>
          </div>
        </div>
      </div>
    </header>

    <main class="main">
      <div class="grid" id="app"></div>
      <div class="spacer"></div>
    </main>
  </div>

  <!-- Modal -->
  <div class="modalOverlay" id="modalOverlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="modalHead">
        <div class="mhTitle" id="modalTitle">Checkout</div>
        <button class="x" id="modalClose" aria-label="Close">✕</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
    </div>
  </div>

  <div class="toasts" id="toasts"></div>

<script>
(() => {
  const state = {
    view: "home",
    selected: new Set(),
    walletAddress: null,
    ethWeeklyAth: null,
    ethAthFetchedAt: 0,
    lastStatus: null,
    products: [
      {
        id: "simple-sample",
        name: "Glitch 1.0 — Simple Sample",
        usd: 50,
        kind: "Demo",
        term: "2 months",
        blurb: "One trade at a time. Low-noise execution.",
        tags: ["Demo • 2 months", "1 trade at a time", "Lower risk"],
        equityImg: "./assets/charts/simple-sample-equity.webp",
        backtestImg: "./assets/charts/simple-sample-backtest.webp",
      },
      {
        id: "legacy-builder",
        name: "Glitch 2.0 — Legacy Builder",
        usd: 70,
        kind: "Demo",
        term: "2 months",
        blurb: "Slow compounding. Built for patience.",
        tags: ["Demo • 2 months", "Wealth mode", "Calm execution"],
        equityImg: "./assets/charts/legacy-builder-equity.webp",
        backtestImg: "./assets/charts/legacy-builder-backtest.webp",
      },
      {
        id: "fuck-gold",
        name: "Pro — F*ck Gold",
        usd: 500,
        kind: "Pro",
        term: "Lifetime",
        blurb: "One-time payment. Lifetime access.",
        tags: ["One-time", "Lifetime", "Full power"],
        equityImg: "./assets/charts/fuck-gold-equity.webp",
        backtestImg: "./assets/charts/fuck-gold-backtest.webp",
      },
      {
        id: "little-glitcher",
        name: "Little Glitcher",
        usd: 150,
        kind: "Utility",
        term: "Lifetime",
        blurb: "Run demos across up to 10 terminals. Extend demo runtime.",
        tags: ["Utility", "Up to 10 terminals", "Extends demo runtime"],
        equityImg: "./assets/charts/little-glitcher-equity.webp",
        backtestImg: "./assets/charts/little-glitcher-backtest.webp",
      }
    ]
  };

  // --------- Helpers ----------
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));
  const app = $("#app");

  function money(n){
    return new Intl.NumberFormat("en-US",{ style:"currency", currency:"USD", maximumFractionDigits:0 }).format(n);
  }
  function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }

  function setView(v){
    state.view = v;
    $$("#tabs .pill").forEach(p => p.classList.toggle("active", p.dataset.view === v));
    render();
  }

  function toggleSelect(id){
    if (state.selected.has(id)) state.selected.delete(id);
    else state.selected.add(id);
    persistSelection();
    updateCartUI();
    render(); // reflect selected states
  }

  function persistSelection(){
    try{
      localStorage.setItem("egg_selected", JSON.stringify([...state.selected]));
    }catch{}
  }
  function loadSelection(){
    try{
      const raw = localStorage.getItem("egg_selected");
      if (!raw) return;
      JSON.parse(raw).forEach(id => state.selected.add(id));
    }catch{}
  }

  function updateCartUI(){
    $("#cartCount").textContent = String(state.selected.size);
  }

  // --------- Wallet address loader (case-sensitive filename) ----------
  async function loadWalletAddress(){
    if (state.walletAddress !== null) return state.walletAddress;

    try{
      const res = await fetch("./Address.txt", { cache: "no-store" });
      const txtRaw = await res.text();
      const txt = (txtRaw || "").trim();

      // Guard: if SPA fallback served HTML, bail
      if (txt.startsWith("<!DOCTYPE") || txt.startsWith("<html") || txt.includes("<head") || txt.includes("EasyGoldGlitch")) {
        state.walletAddress = "";
        return state.walletAddress;
      }

      const addr = txt.replace(/\s+/g, "");
      const isEth = /^0x[a-fA-F0-9]{40}$/.test(addr);
      state.walletAddress = isEth ? addr : "";
      return state.walletAddress;
    }catch{
      state.walletAddress = "";
      return state.walletAddress;
    }
  }

  // --------- ETH Weekly ATH (CoinGecko) ----------
  async function getEthWeeklyAthUSD(){
    const now = Date.now();
    if (state.ethWeeklyAth && (now - state.ethAthFetchedAt) < 15*60*1000) return state.ethWeeklyAth;

    // Cache layer
    try{
      const cached = JSON.parse(localStorage.getItem("egg_eth_ath_cache") || "null");
      if (cached && cached.v && (now - cached.t) < 15*60*1000){
        state.ethWeeklyAth = cached.v;
        state.ethAthFetchedAt = cached.t;
        return state.ethWeeklyAth;
      }
    }catch{}

    // CoinGecko market_chart: last 7 days
    const url = "https://api.coingecko.com/api/v3/coins/ethereum/market_chart?vs_currency=usd&days=7&interval=hourly";
    const res = await fetch(url, { cache:"no-store" });
    if(!res.ok) throw new Error("Price feed unavailable");
    const data = await res.json();
    const prices = (data && data.prices) ? data.prices : [];
    let max = 0;
    for (const p of prices){
      const v = Number(p[1] || 0);
      if (v > max) max = v;
    }
    max = Math.max(1, max);

    state.ethWeeklyAth = max;
    state.ethAthFetchedAt = now;
    try{ localStorage.setItem("egg_eth_ath_cache", JSON.stringify({ v:max, t:now })); }catch{}
    return max;
  }

  async function usdToEthAtWeeklyAth(usd){
    const ath = await getEthWeeklyAthUSD();
    const eth = usd / ath;
    return eth;
  }

  // --------- Views ----------
  function viewHome(){
    return `
      <section class="card hero">
        <div class="inner">
          <div class="kicker">Crypto-native • No sign-up</div>
          <h1>Stop trading.<br/>Start printing.</h1>
          <p>Choose a glitch. Pay in ETH. Get it delivered.</p>
          <div class="ctaRow">
            <button class="btn gold" id="goGlitches">Browse glitches</button>
            <button class="btn ghost" id="goCheckout">Checkout</button>
          </div>
        </div>
      </section>

      <div class="sectionTitle">
        <div>
          <h2>Fast picks</h2>
          <div class="sub">Low text. High signal.</div>
        </div>
        <div class="sub">ETH price uses weekly high.</div>
      </div>

      ${state.products.slice(0,3).map(p => productCard(p)).join("")}
    `;
  }

  function productCard(p){
    const sel = state.selected.has(p.id);
    return `
      <section class="card product" data-pid="${p.id}">
        <div class="inner">
          <div class="row">
            <div>
              <div class="pname">${escapeHtml(p.name)}</div>
              <div class="pblurb">${escapeHtml(p.blurb)}</div>
              <div class="tags">
                ${p.tags.map(t => `<span class="tag">${escapeHtml(t)}</span>`).join("")}
              </div>
            </div>
            <div class="price">
              <b>${money(p.usd)}</b>
              <div>${escapeHtml(p.kind)} • ${escapeHtml(p.term)}</div>
            </div>
          </div>

          <div class="pactions">
            <button class="btn mini ${sel ? "selected" : ""}" data-action="toggle" data-id="${p.id}">
              ${sel ? "Selected" : "Select"}
            </button>
            <button class="btn mini" data-action="details" data-id="${p.id}">View</button>
          </div>
        </div>
      </section>
    `;
  }

  function viewGlitches(){
    return `
      <div class="sectionTitle">
        <div>
          <h2>Glitches</h2>
          <div class="sub">Pick now. Decide later.</div>
        </div>
        <div class="sub">${state.selected.size} selected</div>
      </div>
      ${state.products.map(p => productCard(p)).join("")}
    `;
  }

  function viewPhilosophy(){
    return `
      <section class="card" style="grid-column:1/-1;">
        <div class="inner">
          <h2 style="margin:0;font-size:18px;letter-spacing:-.2px;">Philosophy</h2>
          <p style="margin:10px 0 0;color:rgba(255,255,255,.72);font-size:14px;line-height:1.55;max-width:760px;">
            The founder kept losing on “perfect” manual entries — always late, always hunted.
            So he stopped fighting algorithms… and built glitches instead.
          </p>
          <div class="tags" style="margin-top:14px;">
            <span class="tag">System-aware</span>
            <span class="tag">Emotionless execution</span>
            <span class="tag">Low-noise design</span>
          </div>
        </div>
      </section>
    `;
  }

  function viewTerms(){
    return `
      <section class="card" style="grid-column:1/-1;">
        <div class="inner">
          <h2 style="margin:0;font-size:18px;letter-spacing:-.2px;">Terms & Risk</h2>

          <p style="margin:10px 0 0;color:rgba(255,255,255,.72);font-size:13px;line-height:1.6;max-width:920px;">
            Trading is high-risk. You can lose some or all of your capital. Nothing here is financial advice.
            We are not a broker, dealer, or investment advisor. Past performance does not guarantee future results.
          </p>

          <p style="margin:10px 0 0;color:rgba(255,255,255,.70);font-size:13px;line-height:1.6;max-width:920px;">
            No refunds. Digital goods are delivered as-is, with no warranties of profitability or fitness for purpose.
            Our executables use <b>virtual SL/TP</b> (not visible to the broker). Keep the executable running with MT5 open.
          </p>

          <p style="margin:10px 0 0;color:rgba(255,255,255,.70);font-size:13px;line-height:1.6;max-width:920px;">
            Demo licenses last <b>2 months</b> from activation. Little Glitcher is a utility to extend demo runtime
            and manage multi-terminal demo operation (up to 10 terminals). Pro (“F*ck Gold”) is one-time payment, lifetime access.
          </p>

          <div class="tags" style="margin-top:14px;">
            <span class="tag">No financial advice</span>
            <span class="tag">High risk</span>
            <span class="tag">No refunds</span>
            <span class="tag">Virtual SL/TP</span>
            <span class="tag">Demo: 2 months</span>
          </div>
        </div>
      </section>
    `;
  }

  // --------- Modals ----------
  function openModal(title, bodyHTML){
    $("#modalTitle").textContent = title;
    $("#modalBody").innerHTML = bodyHTML;
    $("#modalOverlay").classList.add("show");
    $("#modalOverlay").setAttribute("aria-hidden","false");
  }
  function closeModal(){
    $("#modalOverlay").classList.remove("show");
    $("#modalOverlay").setAttribute("aria-hidden","true");
  }

  function productDetailsModal(p){
    const sel = state.selected.has(p.id);
    openModal("Glitch", `
      <div class="mgrid">
        <div class="panel">
          <div class="pi">
            <h3>${escapeHtml(p.name)}</h3>
            <p>${escapeHtml(p.blurb)}</p>
            <div class="tags">${p.tags.map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join("")}</div>

            <div class="split" style="margin-top:12px;">
              <div>
                <div class="imgBox" title="Equity curve">
                  <img src="${p.equityImg}" alt="Equity curve"
                       onerror="this.remove(); this.parentNode.textContent='Equity image not found';" />
                </div>
              </div>
              <div>
                <div class="imgBox" title="Backtest">
                  <img src="${p.backtestImg}" alt="Backtest"
                       onerror="this.remove(); this.parentNode.textContent='Backtest image not found';" />
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="panel">
          <div class="pi">
            <h3>Buy</h3>
            <p>Pay in ETH. Delivery by email.</p>

            <div class="status" id="ethQuote">Loading ETH quote…</div>

            <div class="pactions" style="margin-top:12px;">
              <button class="btn mini ${sel ? "selected" : ""}" data-action="toggle" data-id="${p.id}">
                ${sel ? "Selected" : "Select"}
              </button>
              <button class="btn mini gold" id="goCheckoutFromDetails">Checkout</button>
            </div>

            <div class="note">
              ETH amount uses weekly high (conservative).
            </div>
          </div>
        </div>
      </div>
    `);

    // Quote ETH in modal
    (async () => {
      try{
        const eth = await usdToEthAtWeeklyAth(p.usd);
        $("#ethQuote").className = "status ok";
        $("#ethQuote").textContent = `${money(p.usd)} ≈ ${eth.toFixed(6)} ETH (weekly high)`;
      }catch{
        $("#ethQuote").className = "status bad";
        $("#ethQuote").textContent = "ETH quote unavailable. Try again later.";
      }
    })();

    $("#goCheckoutFromDetails").onclick = () => { closeModal(); openCheckout(); };
  }

  async function openCheckout(){
    const picked = state.products.filter(p => state.selected.has(p.id));
    const totalUSD = picked.reduce((a,p)=>a+p.usd,0);

    const walletAddr = await loadWalletAddress();
    let ethLine = "Loading ETH total…";
    let ethTotal = null;

    openModal("Checkout", `
      <div class="mgrid">
        <div class="panel">
          <div class="pi">
            <h3>Your picks</h3>
            <p>${picked.length ? "Ready when you are." : "Select a glitch first."}</p>

            <div class="status" style="margin-top:12px;">
              ${picked.length ? picked.map(p => `• ${escapeHtml(p.name)} — <b>${money(p.usd)}</b>`).join("<br/>") : "No items selected."}
              ${picked.length ? `<div style="margin-top:10px;"><b>Total:</b> ${money(totalUSD)}</div>` : ""}
            </div>

            <div class="status" id="ethTotalBox">${ethLine}</div>

            <div class="field">
              <label>Email (required)</label>
              <input id="email" type="email" placeholder="you@domain.com" autocomplete="email" />
            </div>

            <div class="checkRow">
              <input type="checkbox" id="agree" />
              <span>I agree to the Terms & Risk. No refunds. High risk. Demo lasts 2 months.</span>
            </div>

            <div class="field">
              <label>TxHash (paste after sending ETH)</label>
              <input id="txhash" type="text" placeholder="0x…" autocomplete="off" spellcheck="false" />
            </div>

            <div class="pactions">
              <button class="btn mini gold" id="verifyBtn">Verify payment</button>
              <button class="btn mini" id="backToGlitches">Back</button>
            </div>

            <div class="status" id="verifyStatus" style="display:none;"></div>
          </div>
        </div>

        <div class="panel">
          <div class="pi">
            <h3>Pay in ETH</h3>
            <p>Scan QR or copy address.</p>

            <div class="walletRow">
              <div class="qr">
                <img src="./wallet.png" alt="Wallet QR"
                     onerror="this.style.display='none'; this.parentNode.textContent='QR not found';" />
              </div>
              <div class="addrBox">
                <div>
                  <div style="font-size:12px;color:rgba(255,255,255,.65);">Destination</div>
                  <div class="mono" id="walletAddr">${walletAddr ? walletAddr : "Wallet address not available (check Address.txt deployment)"} </div>
                </div>
                <div class="addrActions">
                  <button class="btn mini" id="copyAddr">Copy</button>
                  <button class="btn mini" id="copyTotal">Copy ETH total</button>
                </div>
              </div>
            </div>

            <div class="note">
              If you pay from an exchange, send to the exact address above. Then paste the TxHash.
            </div>
          </div>
        </div>
      </div>
    `);

    // Bind buttons
    $("#backToGlitches").onclick = () => { closeModal(); setView("glitches"); };
    $("#copyAddr").onclick = async () => {
      const t = ($("#walletAddr").textContent || "").trim();
      await safeCopy(t);
      toast("Copied", "Wallet address copied.");
    };
    $("#copyTotal").onclick = async () => {
      const t = (ethTotal !== null) ? ethTotal.toFixed(6) : "";
      await safeCopy(t);
      toast("Copied", "ETH total copied.");
    };

    // Fetch ETH total
    (async () => {
      if (!picked.length){
        $("#ethTotalBox").className = "status bad";
        $("#ethTotalBox").textContent = "Select at least one glitch.";
        return;
      }
      try{
        const eth = await usdToEthAtWeeklyAth(totalUSD);
        ethTotal = eth;
        $("#ethTotalBox").className = "status ok";
        $("#ethTotalBox").textContent = `${money(totalUSD)} ≈ ${eth.toFixed(6)} ETH (weekly high)`;
      }catch{
        $("#ethTotalBox").className = "status bad";
        $("#ethTotalBox").textContent = "ETH total unavailable. Try again later.";
      }
    })();

    // Verify payment (placeholder endpoint)
    $("#verifyBtn").onclick = async () => {
      const email = ($("#email").value || "").trim();
      const agree = $("#agree").checked;
      const tx = ($("#txhash").value || "").trim();

      const status = $("#verifyStatus");
      status.style.display = "block";

      if (!picked.length) return showStatus("bad", "No items selected.", status);
      if (!agree) return showStatus("bad", "You must accept Terms & Risk.", status);
      if (!email || !email.includes("@")) return showStatus("bad", "Enter a valid email.", status);
      if (!/^0x[a-fA-F0-9]{64}$/.test(tx)) return showStatus("bad", "TxHash format looks wrong.", status);
      if (!walletAddr) return showStatus("bad", "Wallet address not available. Fix Address.txt first.", status);

      showStatus("", "Checking payment…", status);

      try{
        const payload = {
          email,
          txHash: tx,
          expectedUsd: totalUSD,
          expectedEth: ethTotal,
          items: picked.map(p => ({ id:p.id, usd:p.usd })),
          destination: walletAddr
        };

        const res = await fetch("/api/verify", {
          method:"POST",
          headers:{ "content-type":"application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok){
          const txt = await res.text().catch(()=> "");
          return showStatus("bad", `Verify endpoint not ready (${res.status}). ${txt ? "Response received." : ""}`, status);
        }

        const out = await res.json();
        showStatus("ok", out && out.ok ? "Payment verified. Check your email." : "Payment not verified yet.", status);
      }catch{
        showStatus("bad", "Network error. Backend not live yet.", status);
      }
    };
  }

  function showStatus(kind, msg, el){
    el.className = "status" + (kind ? (" " + kind) : "");
    el.textContent = msg;
  }

  // --------- Render ----------
  function render(){
    let html = "";
    if (state.view === "home") html = viewHome();
    if (state.view === "glitches") html = viewGlitches();
    if (state.view === "philosophy") html = viewPhilosophy();
    if (state.view === "terms") html = viewTerms();

    app.innerHTML = html;

    // bind home buttons
    const goG = $("#goGlitches");
    if (goG) goG.onclick = () => setView("glitches");
    const goC = $("#goCheckout");
    if (goC) goC.onclick = () => openCheckout();

    // bind product actions
    $$("[data-action='toggle']").forEach(btn => {
      btn.onclick = (e) => toggleSelect(e.currentTarget.dataset.id);
    });
    $$("[data-action='details']").forEach(btn => {
      btn.onclick = (e) => {
        const id = e.currentTarget.dataset.id;
        const p = state.products.find(x => x.id === id);
        if (p) productDetailsModal(p);
      };
    });
  }

  // Tabs
  $("#tabs").addEventListener("click", (e) => {
    const pill = e.target.closest(".pill");
    if (!pill) return;
    setView(pill.dataset.view);
  });

  // Cart button
  $("#cartBtn").onclick = () => openCheckout();

  // Modal close
  $("#modalClose").onclick = closeModal;
  $("#modalOverlay").addEventListener("click", (e) => {
    if (e.target === $("#modalOverlay")) closeModal();
  });
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeModal();
  });

  // Safe copy
  async function safeCopy(text){
    try{ await navigator.clipboard.writeText(text || ""); }catch{}
  }

  // Toasts
  const cities = ["NYC","LA","Miami","London","Dubai","Toronto","Madrid","Bogotá","Berlin","Seoul","Tokyo"];
  function toast(title, msg){
    const root = $("#toasts");
    const el = document.createElement("div");
    el.className = "toast";
    el.innerHTML = `<b>${escapeHtml(title)}</b><div>${escapeHtml(msg)}</div>`;
    root.appendChild(el);
    requestAnimationFrame(()=> el.classList.add("show"));
    setTimeout(()=> { el.classList.remove("show"); }, 3300);
    setTimeout(()=> { el.remove(); }, 3800);
  }

  // Lightweight “sold” dopamine toasts
  function startSoldToasts(){
    setInterval(() => {
      const pick = state.products[Math.floor(Math.random()*state.products.length)];
      const city = cities[Math.floor(Math.random()*cities.length)];
      toast("Sold", `${pick.name} • ${city}`);
    }, 8500);
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // --------- Particles (dopamine glass) ----------
  const canvas = $("#fx");
  const ctx = canvas.getContext("2d", { alpha:true });
  let W=0,H=0, DPR=1;
  const mouse = { x:0, y:0, down:false, vx:0, vy:0 };
  const N = 110;
  const P = [];
  const links = 90;

  function resize(){
    DPR = Math.min(2, window.devicePixelRatio || 1);
    W = Math.floor(window.innerWidth);
    H = Math.floor(window.innerHeight);
    canvas.width = Math.floor(W * DPR);
    canvas.height = Math.floor(H * DPR);
    canvas.style.width = W + "px";
    canvas.style.height = H + "px";
    ctx.setTransform(DPR,0,0,DPR,0,0);
  }
  window.addEventListener("resize", resize);

  function rand(a,b){ return a + Math.random()*(b-a); }

  function init(){
    resize();
    P.length = 0;
    for(let i=0;i<N;i++){
      const goldBias = (Math.random() < 0.22);
      P.push({
        x: rand(0,W),
        y: rand(0,H),
        r: rand(1.2, goldBias ? 2.7 : 2.2),
        vx: rand(-0.35,0.35),
        vy: rand(-0.25,0.25),
        a: rand(0.22, 0.85),
        gold: goldBias,
        drift: rand(0.2, 1.0)
      });
    }
  }

  function step(){
    ctx.clearRect(0,0,W,H);

    // soft glow pass
    ctx.globalCompositeOperation = "lighter";

    for(const p of P){
      // gentle drift + mouse magnet
      const dx = (mouse.x - p.x);
      const dy = (mouse.y - p.y);
      const dist = Math.sqrt(dx*dx + dy*dy) || 1;
      const pull = clamp(160/dist, 0, 1) * 0.04;

      p.vx += (dx/dist) * pull * p.drift * (mouse.down ? 1.6 : 1.0);
      p.vy += (dy/dist) * pull * p.drift * (mouse.down ? 1.6 : 1.0);

      // friction
      p.vx *= 0.98;
      p.vy *= 0.98;

      p.x += p.vx;
      p.y += p.vy;

      // wrap
      if (p.x < -20) p.x = W + 20;
      if (p.x > W + 20) p.x = -20;
      if (p.y < -20) p.y = H + 20;
      if (p.y > H + 20) p.y = -20;

      // draw dot
      const g = p.gold;
      const col = g ? `rgba(215,181,106,${p.a})` : `rgba(255,255,255,${p.a})`;
      ctx.beginPath();
      ctx.fillStyle = col;
      ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
      ctx.fill();

      // glow
      ctx.beginPath();
      ctx.fillStyle = g ? `rgba(240,218,154,${p.a*0.22})` : `rgba(255,255,255,${p.a*0.12})`;
      ctx.arc(p.x, p.y, p.r*4.0, 0, Math.PI*2);
      ctx.fill();
    }

    // link lines (limited)
    ctx.globalCompositeOperation = "screen";
    for(let i=0;i<links;i++){
      const a = P[Math.floor(Math.random()*P.length)];
      const b = P[Math.floor(Math.random()*P.length)];
      const dx = a.x - b.x;
      const dy = a.y - b.y;
      const d = Math.sqrt(dx*dx + dy*dy);
      if (d > 140) continue;
      const alpha = (1 - d/140) * 0.14;
      ctx.strokeStyle = `rgba(215,181,106,${alpha})`;
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(a.x, a.y);
      ctx.lineTo(b.x, b.y);
      ctx.stroke();
    }

    ctx.globalCompositeOperation = "source-over";
    requestAnimationFrame(step);
  }

  window.addEventListener("pointermove", (e)=>{ mouse.x = e.clientX; mouse.y = e.clientY; });
  window.addEventListener("pointerdown", ()=>{ mouse.down = true; });
  window.addEventListener("pointerup", ()=>{ mouse.down = false; });

  // Boot
  loadSelection();
  updateCartUI();
  render();
  init();
  step();
  startSoldToasts();

})();
</script>
</body>
</html>
